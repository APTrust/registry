{{ define "reports/_deposit_chart.html" }}

<!-- Chart -->
<div class="row">
  <canvas id="depositChart" style="height: 400px;"></canvas>
</div>

<script>
 const depositData = {{ toJSON .deposits }};
 const reportParams = {{ toJSON .reportParams }};

 function renderChart(elementId, label) {
     let ctx = document.getElementById(elementId);
     let data = buildChartData()
     return new Chart(ctx, { type: 'bar', data: data })
 }

 function buildChartData() {
     let labels = getLabels()
     return {
         labels: labels,
         datasets: [{
             label: 'Deposits as of {{ dateUS .reportParams.UpdatedBefore }}',
             data: depositData.map(item => item.total_gb),
             backgroundColor: window.APT.chartColors('bar', labels.length),
             borderColor: window.APT.chartColors('border', labels.length),
             borderWidth: 1
         }]
     }
 }

 function getLabels() {
     let includeName = true
     let includeStorageOption = true
     let includeSumTotals = true
     if (reportParams.InstitutionID > 0) {
         includeName = false
         includeSumTotals = false
     }
//     if (reportParams.StorageOption != "") {
//         includeStorageOption = false
//     }
     let labels = []
     for (let d of depositData) {
         if (!includeSumTotals && d.institution_name == 'Total') {
             continue
         }
         let label = [];
         if (includeName) {
             label.push(d.institution_name)
         }
         if (includeStorageOption) {
             label.push(d.storage_option)
         }
         labels.push(label.join(' '))
     }
     // depositData.map(item => `${item.institution_name} ${item.storage_option}`)
     return labels
 }

 // Render the chart after APTLoaded (aptLoadEvent) because it depends
 // on APT.chartColors.
 window.addEventListener('APTLoaded', (event) => {
     renderChart("depositChart", "Deposits")
 });

</script>

{{ end }}
