{{ define "reports/_deposit_chart.html" }}

<!-- Chart -->
<div class="px-6">
  <canvas id="depositChart" style="height: 400px;"></canvas>
</div>

<script>
 var depositChart = null
 const depositData = {{ toJSON .deposits }}; 
 const reportParams = {{ toJSON .reportParams }};

 function renderChart() {
     let metricSelect = document.forms["depositReportFilterForm"].elements["chart_metric"];
     let label = metricSelect[metricSelect.selectedIndex].text
     let metric = metricSelect.value
     if (metric == "") {
         metric = metricSelect.value = "total_gb"
     }
     let reportType = document.forms["depositReportFilterForm"].elements["report_type"].value
     let ctx = document.getElementById("depositChart");
     // let data = buildBarChartData(label, metric)
     if (depositChart != null) {
        depositChart.destroy()
     }
     //if (depositChart == null) {
        if (reportType == 'by_inst') {
            depositChart = new Chart(ctx, { 
                type: 'bar', 
                data: buildBarChartData(label, metric),
                options: {
                    maintainAspectRatio: false,
                }
            })
        } else {
            let lineChartData = buildLineChartData(label, metric)
            console.log(depositData)
            console.log(lineChartData)
            depositChart = new Chart(ctx, { 
                type: 'line', 
                data: lineChartData,
                options: {
                    maintainAspectRatio: false,
                    elements: {
                        point:{
                            radius: 0
                        }
                    }
                }            
            })
        }
     //} else {
     //    depositChart.data = data
     //    depositChart.update()
     //}
 }

 function buildBarChartData(label, metric) {
     let labels = getBarChartLabels()
     return {
         labels: labels,
         datasets: [{
             label: label + ' {{ dateUS .reportParams.UpdatedBefore }}',
             data: getBarDepositData(metric),
             backgroundColor: window.APT.chartColors('fill', labels.length),
             borderColor: window.APT.chartColors('border', labels.length),
             borderWidth: 1
         }]
     }
 }

 function getBarDepositData(metric) {
     return depositData.map(item => item[metric])
 }


 function buildLineChartData(label, metric) {
    //console.log(depositData.length)
    //fillOutLineChartData()
    //console.log(depositData.length)
    let sets = []
    let xAxisLabels = new Set()
    let lastId = ""
    let currentSet = null
    for (var i = 0; i < depositData.length; i++) {
        let entry = depositData[i]
        let endDate = entry.end_date.substr(0,10)
        let currentId = entry.institution_name + entry.storage_option
        if (currentId != lastId) {
            let label = `${entry.institution_name} - ${entry.storage_option}`
            currentSet = {
                label: label,
                data: [],
                backgroundColor: window.APT.chartColors('fill', i),
                borderColor: window.APT.chartColors('border', i),
                borderWidth: 1
            }
            sets.push(currentSet)
            lastId = currentId
            console.log("Added set for " + currentSet.label)
        }
        xAxisLabels.add(endDate)
        currentSet.data.push(entry[metric])
        console.log(`${entry[metric]} to  ${i} - ${entry.institution_id} ${endDate} ${entry.storage_option}`)
        //console.log(entry)
    }
    return { 
        labels: Array.from(xAxisLabels).sort(),
        datasets: sets 
    }
 }


//  function fillOutLineChartData() {
//     let dates = new Set()
//     let opts = new Set()
//     let institutions = new Set()
//     let exists = {}
//     let nameFor = {}
//     for (var i = 0; i < depositData.length; i++) {
//         let entry = depositData[i]
//         dates.add(entry.end_date)
//         opts.add(entry.storage_option)
//         institutions.add(entry.institution_id)
//         nameFor[entry.institution_id] = entry.institution_name
//         let key = entry.institution_id + entry.storage_option + entry.end_date
//         exists[key] = true
//         //console.log("Exists: " + key)
//     }
//     let dateArray = Array.from(dates)
//     let optsArray = Array.from(opts)
//     let instArray = Array.from(institutions)
//     for (var i = 0; i < dateArray.length; i++) {
//         for (var j = 0; j < optsArray.length; j++) {
//             for (var x = 0; x < instArray.length; x++) {
//                 let inst = instArray[x]
//                 let date = dateArray[i]
//                 let opt = optsArray[j]
//                 let key = inst + opt + date
//                 if (!exists[key]) {
//                     //console.log("Adding " + date + " for " + inst + " for " + opt)
//                     depositData.push({
//                         "institution_id": inst,
// 	                    "member_institution_id": 0,
// 	                    "institution_name": nameFor[inst],
// 	                    "storage_option": opt,
// 	                    "object_count": 0,
// 	                    "file_count": 0,
// 	                    "total_bytes": 0,
// 	                    "total_gb": 0,
// 	                    "total_tb": 0,
// 	                    "cost_gb_per_month": 0,
// 	                    "monthly_cost": 0,
// 	                    "end_date": date                        
//                     })
//                 }
//             }
//         }
//     }
//     depositData.sort((a, b) => (a.institution_id < b.institution_id && a.storage_option < b.storage_option && a.end_date < b.end_date))
//  }



 function getBarChartLabels() {
     let includeName = true
     let includeOptionTotals = true
     let includeInstTotals = true
     if (reportParams.InstitutionID > 0) {
         includeName = false
         includeInstTotals = false
     }
     if (reportParams.StorageOption != "") {
         includeOptionTotals = false
     }
     let labels = []
     for (let d of depositData) {
         if (!includeInstTotals && d.institution_name == 'Total') {
             continue
         }
         if (!includeOptionTotals && d.storage_option == 'Total') {
             continue
         }
         labels.push(`${d.institution_name} ${d.storage_option}`)
     }
     return labels
 }

//  var months = ['Jan', 'Feb', 'March', 'April', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']

//  function getLineChartLabels() {
//      let labels = []
//      for (let d of depositData) {
//         date = new Date(d.end_date)
//         labels.push(`${months[date.getMonth()]} ${date.getYear() + 1900}`)
//      }
//      return labels
//  }

 // Render the chart after APTLoaded (aptLoadEvent) because it depends
 // on APT.chartColors.
 window.addEventListener('APTLoaded', (event) => {
     renderChart()
     document.forms["depositReportFilterForm"].elements["chart_metric"].addEventListener('change', (event) => {
         renderChart()
     });
 });

</script>


{{ end }}
