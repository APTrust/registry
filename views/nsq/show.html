{{ define "nsq/show.html" }}

{{ template "shared/_header.html" .}}

<h1>NSQ</h1>

<p>Version {{ .stats.Info.Version }} running at <b>{{ .stats.Info.BroadcastAddress }}:{{ .stats.Info.HttpPort }}</b> (TCP port {{ .stats.Info.TcpPort }}). </p>
<p>Started {{ unixToISO .stats.Info.StartTime }}. Health: {{ .stats.Health }}.</p>
<p>Nothing here? <a href="javascript:nsqInit()">Initialize NSQ</a></p>
<ul>
  <li><a href="javascript:nsqPost('pause', '', '', 'topic', true)" title="Pause all topics">Pause All Topics</a></li>
  <li><a href="javascript:nsqPost('unpause', '', '', 'topic', false)">Unpause All Topics</a></li>
  <li><a href="javascript:nsqPost('empty', '', '', 'topic', true)">Empty All Topics</a></li>
  <li><a href="javascript:nsqPost('delete', '', '', 'topic', true)">Delete All Topics</a></li>

  <li><a href="javascript:nsqPost('pause', '', '', 'channel', true)" title="Pause all channels">Pause All Channels</a></li>
  <li><a href="javascript:nsqPost('unpause', '', '', 'channel', false)">Unpause All Channels</a></li>
  <li><a href="javascript:nsqPost('empty', '', '', 'channel', true)">Empty All Channels</a></li>
  <li><a href="javascript:nsqPost('delete', '', '', 'channel', true)">Delete All Channels</a></li>

</ul>

{{ range $index, $topic := .stats.Topics }}
<table>
  <tr>
    <td><h4>{{ $topic.TopicName }}</h4></td>
    <td>
      {{ if $topic.Paused }}
      <button onclick="nsqPost('unpause', '{{ $topic.TopicName }}', '', 'topic', false)" title="Unpause topic {{ $topic.TopicName }}">Unpause</button>
      {{ else }}
      <button onclick="nsqPost('pause', '{{ $topic.TopicName }}', '', 'topic', false)" title="Pause topic {{ $topic.TopicName }}">Pause</button>
      {{ end }}
    </td>
    <td><button onclick="nsqPost('empty', '{{ $topic.TopicName }}', '', 'topic', false)" title="Empty topic {{ $topic.TopicName }}">Empty</button></td>
    <td><button onclick="nsqPost('delete', '{{ $topic.TopicName }}', '', 'topic', false)" title="Delete topic {{ $topic.TopicName }}">Delete</button></td>
  </tr>
</table>
<table style="margin-bottom: 160px;">
  <tr>
    <th></th>
    <th>Depth</th>
    <th>Backend Depth</th>
    <th>In Flight</th>
    <th>Deferred</th>
    <th>Messages</th>
    <th>Requeued</th>
    <th>Timed Out</th>
    <th>Clients</th>
  </tr>
  <tr>
    <td>Topic Totals</td>
    <td>{{ $topic.Depth }}</td>
    <td>{{ $topic.BackendDepth }}</td>
    <td></td>
    <td></td>
    <td>{{ $topic.MessageCount }}</td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  {{ range $chIndex, $channel := $topic.Channels }}
  <tr>
    <td>
      {{ $channel.ChannelName }} <br/>
      {{ if $channel.Paused }}
      <a href="javascript:nsqPost('unpause', '{{ $topic.TopicName }}', '{{ $channel.ChannelName }}', 'channel', false)" title="Unpause channel {{ $channel.ChannelName }}">Unpause</a>
      {{ else }}
      <a href="javascript:nsqPost('pause', '{{ $topic.TopicName }}', '{{ $channel.ChannelName }}', 'channel', false)" title="Pause channel {{ $channel.ChannelName }}">Pause</button>
      {{ end }} |
        <a href="javascript:nsqPost('empty', '{{ $topic.TopicName }}', '{{ $channel.ChannelName }}', 'channel', false)" title="Empty channel {{ $channel.ChannelName }}">Empty</a> |
        <a href="javascript:nsqPost('delete', '{{ $topic.TopicName }}', '{{ $channel.ChannelName }}', 'channel', false)" title="Delete channel {{ $channel.ChannelName }}">Delete</a>
    </td>
    <td>{{ $channel.Depth }}</td>
    <td>{{ $channel.BackendDepth }}</td>
    <td>{{ $channel.InFlightCount }}</td>
    <td>{{ $channel.DeferredCount }}</td>
    <td>{{ $channel.MessageCount }}</td>
    <td>{{ $channel.RequeueCount }}</td>
    <td>{{ $channel.TimeoutCount }}</td>
    <td>{{ $channel.ClientCount }}</td>
  </tr>
  {{ if $channel.Clients }}
  <tr>
    <th colspan="2">Client</th>
    <th>State</th>
    <th>Ready Count</th>
    <th>In Flight</th>
    <th>Messages</th>
    <th>Finished</th>
    <th>Requeued</th>
    <th>Connected Since</th>
  </tr>
  {{ if $channel.Clients }}
  {{ range $clIndex, $client := $channel.Clients }}
  <tr>
    <td colspan="2">{{ $client.ClientID }}</td>
    <td>{{ $client.State }}</td>
    <td>{{ $client.ReadyCount }}</td>
    <td>{{ $client.InFlightCount }}</td>
    <td>{{ $client.MessageCount }}</td>
    <td>{{ $client.FinishCount }}</td>
    <td>{{ $client.RequeueCount }}</td>
    <td>{{ unixToISO $client.ConnectTime }}</td>
  </tr>
  {{ end }}
  {{ else }}
  <tr>
    <td colspan="9" style="background-color:#ddd;">No clients connected</td>
  </tr>
  {{ end }}
  {{ end }}
  {{ end }}
</table>
{{ end }}

<form name="nsqForm" method="post" action="/nsq/admin">
  {{ template "forms/csrf_token.html" . }}
  <input type="hidden" name="operation" value="" />
  <input type="hidden" name="targetType" value="" />
  <input type="hidden" name="topicName" value="" />
  <input type="hidden" name="channelName" value="" />
  <input type="hidden" name="applyToAll" value="false" />
</form>

<script>
 function nsqPost(operation, topicName, channelName, targetType, applyToAll) {
     let form = document.forms['nsqForm']
     let msg = getMessage(operation, topicName, channelName, applyToAll)
     console.log(msg)
     if (msg && !confirm(msg)) {
         return
     }
     form.elements['operation'].value = operation
     form.elements['targetType'].value = targetType
     form.elements['topicName'].value = topicName
     form.elements['channelName'].value = channelName
     form.elements['applyToAll'].value = applyToAll ? 'true' : 'false'
     form.submit()
 }

 function nsqInit() {
     let form = document.forms['nsqForm']
     form.action = '/nsq/init'
     form.submit()
 }

 function getMessage(operation, topicName, channelName, applyToAll) {
     if (!applyToAll && (operation == 'pause' || operation == 'unpause')) {
         return null
     }
     let target = topicName
     if (channelName) {
         target = `${channelName} in topic ${topicName}`
     }
     if (applyToAll) {
         if (channelName) {
             target = 'all channels'
         } else {
             target = 'all topics'
         }
     }
     return `Do you want to ${operation} ${target}?`
 }
</script>

{{ template "shared/_footer.html" .}}

{{ end }}
